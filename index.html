<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
	<title>Photo-show</title>
	<script src="js/zepto.min.js"></script>
	<link rel="stylesheet" href="css/animate.css">
	<link rel="stylesheet" href="dialog/dialog.css">
	<style type="text/css">
		html,body,ul,p{
			margin: 0;
			padding: 0;
		}
		body{
			background: #080115;
		}	
		ul{
			list-style: none;
		}
		li{
			overflow: hidden;
			float: left;
		}
		.show-image{
			position: absolute;
			width: 100%;
			height: 100%;
			background: #080115;
			display: none;
		}
		.desc{
			position: absolute;
			bottom: 33px;
			left: 0;
			color: white;
    		text-align: left;
    		padding: 10px;
    		font-size: 18px;
    		letter-spacing: 2px;
    		z-index: 100;
    		display: none;
		}
	</style>
</head>
<body>

	<ul id="container">
	</ul>

	<div id="large-image" class="animated show-image">
		<img class="animated showImg" alt=""/>
		<p class="animated desc"></p>
	</div>
	

	<script src='js/touch.js'></script>
	<script src='js/animate.js'></script>
	<script src='dialog/dialog.js'></script>
	<script>
		var data = [
			{
				"minFile": "1.jpg",
				"maxFile": "1.large.jpg",
				"desc": "关于这幅画面的描述.........."
			},
			{
				"minFile": "2.jpg",
				"maxFile": "2.large.jpg",
				"desc": "关于这幅画面的描述.........."
			},
			{
				"minFile": "3.jpg",
				"maxFile": "3.large.jpg",
				"desc": "关于这幅画面的描述.........."
			},
			{
				"minFile": "4.jpg",
				"maxFile": "4.large.jpg",
				"desc": "关于这幅画面的描述.........."
			},
			{
				"minFile": "5.jpg",
				"maxFile": "5.large.jpg",
				"desc": "关于这幅画面的描述.........."
			},
			{
				"minFile": "6.jpg",
				"maxFile": "6.large.jpg",
				"desc": "关于这幅画面的描述.........."
			},
			{
				"minFile": "7.jpg",
				"maxFile": "7.large.jpg",
				"desc": "关于这幅画面的描述.........."
			},
			{
				"minFile": "8.jpg",
				"maxFile": "8.large.jpg",
				"desc": "关于这幅画面的描述.........."
			},
			{
				"minFile": "9.jpg",
				"maxFile": "9.large.jpg",
				"desc": "关于这幅画面的描述.........."
			},
			{
				"minFile": "10.jpg",
				"maxFile": "10.large.jpg",
				"desc": "关于这幅画面的描述.........."
			},
			{
				"minFile": "11.jpg",
				"maxFile": "11.large.jpg",
				"desc": "关于这幅画面的描述....11......"
			},
			{
				"minFile": "12.jpg",
				"maxFile": "12.large.jpg",
				"desc": "关于这幅画面的描述.....12....."
			},
			{
				"minFile": "13.jpg",
				"maxFile": "13.large.jpg",
				"desc": "关于这幅画面的描述.....13....."
			},
			{
				"minFile": "14.jpg",
				"maxFile": "14.large.jpg",
				"desc": "关于这幅画面的描述.....14....."
			},
			{
				"minFile": "15.jpg",
				"maxFile": "15.large.jpg",
				"desc": "关于这幅画面的描述.....15....."
			},
			{
				"minFile": "16.jpg",
				"maxFile": "16.large.jpg",
				"desc": "关于这幅画面的描述.....16....."
			},
			{
				"minFile": "17.jpg",
				"maxFile": "17.large.jpg",
				"desc": "关于这幅画面的描述.....17....."
			}
		];
		


		var imgs = null;
		var padding = 2;
		var column = 4;
		var win = $(window);
		var container = $('#container');
		var showImg = $('.showImg');
		var largeImg = $('#large-image');
		var index = null;

		var render = function( data ){
			var winWidth = win.width();
			var liWidth = Math.floor( (winWidth - padding*3)/column );
			var model = '';
			
			imgs = data;
			for( var i = 0; i < data.length; i++ ){
				var p = ( (i+1)%column === 1? 0 : padding );
				var imgSrc = 'images/'+ data[i].minFile;
				model += '<li data-id="'+i+'" class="animated zoomIn" style="width:'+liWidth+'px; height:'+liWidth+'px; padding-left:'+ p +'px;padding-top:'+ padding +'px;"><canvas id="cvs_'+ i +'"></canvas></li>';
				
				var imageObj = new Image();
				imageObj.index = i;

				imageObj.onload = function(){
					var cvs = $('#cvs_'+this.index)[0].getContext('2d');
					cvs.width = this.width;
					cvs.height = this.height;
					cvs.drawImage(this, 0, 0);
				};
				imageObj.src = imgSrc;
			}

			container.html(model);

		};

		render(data);

		var loadImg = function(id, callback){
			
			var imgSrc = 'images/'+ imgs[id].maxFile;
			var title = imgs[id].desc;
			var imageObj = new Image();
			
			// 获取当前图片的前一张和后一张的信息
			var _preId = (id - 1) < 0 ? (imgs.length - 1) : (id - 1);
			var _nextId = (id + 1) > (imgs.length - 1) ? 0 : (id + 1);
			console.log(imgs.length+'+++++++++'+_preId+'+++++++++'+(typeof id)+'+++++++++'+_nextId);
			console.log(_preId+'+++++++++'+id+'+++++++++'+_nextId);
			var _preSrc = 'images/'+ imgs[_preId].maxFile,
				_nextSrc = 'images/'+ imgs[_nextId].maxFile;
			var _preImg = new Image();
			var _nextImg = new Image();

			imageObj.onload = function(){
				var w = this.width;
				var h = this.height;
				var winW = win.width();
				var winH = win.height();
				/**计算图片显示时的高度和宽度
				**这里需要注意理解这个reaW和realH究竟是什么值
				**当图片是高大于宽，那么图片显示的高度取值跟屏幕一样
				**图片显示的宽度取值就可以这样计算：w/h = realWidth/realHight（注意图片是等比例缩放关系）
				**所以reaW = realH*w/h,realH = winH; 
				**/
				var realW = winH*w/h;
				var realH = winW*h/w;
				/**计算在展示大图时根据图片的比例来确定左右上下padding值
				**当图片是一个高度大于宽度的图片是使用paddingLeft
				**当图片是一个宽度大于高度的图片是使用paddingTop
				**/ 
				var paddingLeft = parseInt( (winW-realW)/2 );
				var paddingTop = parseInt( (winH-realH)/2 );
				// 设置css样式
				var css = [
					{
						'height': winH,
						'padding-left': paddingLeft
					},
					{
						'width': winW,
						'padding-top': paddingTop
					}
				];
				showImg.css({
					'width': 'auto',
					'height': 'auto',
					'padding-left': '0',
					'padding-top': '0'
				});
				showImg.attr({'src': imgSrc}).css( h/w>1.2 ? css[0] : css[1]);
				$('.desc').html( title );
				callback&&callback();
			};

			imageObj.src = imgSrc;
			// 预加载上下张图片
			_preImg.src = _preSrc;
			_nextImg.src = _nextSrc;

		};


		// 绑定事件代理，加快响应
		container.delegate('li', 'tap', function(){

			largeImg.css({
				width: win.width(),
				height: win.height()
			}).show().addClass('zoomIn');

			var _id = index = parseInt( $(this).attr('data-id') );
			loadImg(_id);

		});


		var fixAnimated = function(ele, type) {
			ele.bind('webkitAnimationEnd', function(){
				$(this).removeClass(type);
				$(this).unbind('webkitAnimationEnd');
			});
			ele.addClass(type);
		};

		// 加入弹出框
		var imgConfig = $('#large-image img').offset();
		var loading = new Dialog({
			type: 'loading',
			width: 300,
			height: 200,
			css: {
				backgroundColor: 'rgba(0,0,0,.6)'
			}
		});
		var msgbox = new Dialog({
			type: 'info',
			width: 300,
			showTime: 1000
		});
		// 关闭图片浏览和实现左右滑动
		largeImg.bind('tap', function(){

			$(this).removeClass('zoomIn').addClass('zoomOut');
			setTimeout(function(){
				largeImg.removeClass('zoomOut').hide();
			},500);	

		}).swipeLeft(function(){
			
			index ++;
			if( index > imgs.length - 1 ){
				index = imgs.length - 1;
				$('#large-image').append(msgbox);
				msgbox.animate({
					opcity: 0
				});
			}else{
				loadImg(index, function(){
					fixAnimated(showImg, 'bounceInRight');
				});
			}
			
		}).swipeRight(function(){

			index --;
			if( index < 0 ){
				index = imgs.length - 1;
			}
			loadImg(index, function(){
				fixAnimated(showImg, 'bounceInLeft');
			});
			
		}).swipeUp(function(){

			$('.desc').show();
			fixAnimated( $('.desc'), 'fadeInUp' );

		}).swipeDown(function(){

			$('.desc').addClass('fadeOutDown');
			setTimeout(function(){
				$('.desc').removeClass('fadeOutDown').hide();
			},500);
		});

		/*
		$.ajax({
			url: 'data/imgdata.json',
			dataType: 'json',
			success: function( data ){
				render(data);
			},
			error: function( error ){
				console.log(error);
			}
		});
		*/

	</script>
</body>
</html>